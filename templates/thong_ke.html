{% extends "base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .stat-card {
        background-color: #1a1a1a;
        color: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        height: 100%;
    }
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        display: flex;
        justify-content: center;
    }
</style>

<div class="container">
    <h2 class="fw-bold mb-4 text-center text-info"><i class="fa-solid fa-chart-line"></i> BÁO CÁO THỐNG KÊ</h2>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="stat-card">
                <h5 class="text-center mb-3 border-bottom pb-2 border-secondary">Tình Trạng Phòng</h5>
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
                <div class="mt-3 text-center small text-secondary">
                    Tổng số phòng: <span class="fw-bold text-light">{{ p_trong + p_da_thue + p_sua }}</span>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="stat-card">
                <h5 class="text-center mb-3 border-bottom pb-2 border-secondary">Doanh Thu Theo Tháng (VNĐ)</h5>
                <div class="chart-container">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="stat-card">
                <h5 class="text-warning mb-3"><i class="fa-solid fa-triangle-exclamation"></i> Các Hợp Đồng Sắp Hết Hạn (Dưới 30 ngày)</h5>
                
                {% if ds_sap_het %}
                <div class="table-responsive">
                    <table class="table table-dark table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Mã Căn</th>
                                <th>Người Thuê</th>
                                <th>Ngày Hết Hạn</th>
                                <th>Còn Lại</th>
                                <th>Hành Động</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for hd in ds_sap_het %}
                            <tr>
                                <td class="fw-bold text-info">{{ hd.ma_can }}</td>
                                <td>{{ hd.nguoi_thue }}</td>
                                <td class="text-warning">{{ hd.ngay_het_han.strftime('%d/%m/%Y') }}</td>
                                <td>
                                    <span class="badge bg-danger">Còn {{ hd.so_ngay }} ngày</span>
                                </td>
                                <td>
                                    <a href="{{ url_for('ql_hop_dong') }}" class="btn btn-sm btn-outline-light">Xem chi tiết</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <p class="text-muted text-center py-3">Không có hợp đồng nào sắp hết hạn trong 30 ngày tới.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. CẤU HÌNH BIỂU ĐỒ TRÒN (PIE CHART) ---
    const ctxPie = document.getElementById('pieChart').getContext('2d');
    new Chart(ctxPie, {
        type: 'pie',
        data: {
            labels: ['Phòng Trống', 'Đã Thuê', 'Đang Sửa'],
            datasets: [{
                data: [{{ p_trong }}, {{ p_da_thue }}, {{ p_sua }}],
                backgroundColor: [
                    '#198754', // Xanh lá (Trống)
                    '#0d6efd', // Xanh dương (Đã thuê)
                    '#dc3545'  // Đỏ (Sửa)
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { color: 'white' } }
            }
        }
    });

    // --- 2. CẤU HÌNH BIỂU ĐỒ CỘT (BAR CHART - DOANH THU) ---
    // Nhận dữ liệu từ Python Flask truyền sang
    const labelsRevenue = {{ labels_dt | tojson }};
    const dataRevenue = {{ values_dt | tojson }};

    const ctxBar = document.getElementById('barChart').getContext('2d');
    new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: labelsRevenue,
            datasets: [{
                label: 'Doanh Thu',
                data: dataRevenue,
                backgroundColor: '#ffc107', // Màu vàng
                borderColor: '#fff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#ccc' },
                    grid: { color: '#444' }
                },
                x: {
                    ticks: { color: '#ccc' },
                    grid: { display: false }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(context.raw);
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}