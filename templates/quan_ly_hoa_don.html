{% extends "base.html" %}

{% block content %}
<style>
    .main-box {
        background-color: #1a1a1a;
        color: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .form-control, .form-select {
        background-color: #2c2c2c;
        border: 1px solid #444;
        color: #fff;
    }
    .form-control:focus {
        background-color: #333;
        color: #fff;
        border-color: #0d6efd;
    }
    .table-dark-custom th {
        background-color: #198754; /* Màu xanh lá cho phần tiền nong */
        color: white;
        text-align: center;
        vertical-align: middle;
        font-size: 0.9rem;
        white-space: nowrap;
    }
    .table-dark-custom td {
        vertical-align: middle;
        text-align: center;
        background-color: #2c2c2c;
        color: #e0e0e0;
        border-color: #444;
        font-size: 0.9rem;
    }
    /* Hiệu ứng nhấp nháy nhẹ cho badge chờ duyệt */
    .blink-soft {
        animation: blinker 2s linear infinite;
    }
    @keyframes blinker {
        50% { opacity: 0.6; }
    }
</style>

<div class="container main-box">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-success"><i class="fa-solid fa-money-bill-wave"></i> Quản Lý Thu Tiền & Hóa Đơn</h2>

        <button class="btn btn-success" type="button" data-bs-toggle="collapse" data-bs-target="#formHoaDon">
            <i class="fa-solid fa-calculator"></i> Lập Hóa Đơn Mới
        </button>
    </div>

    <div class="collapse mb-4" id="formHoaDon">
        <div class="card card-body bg-dark border border-secondary">
            <h5 class="card-title text-warning mb-3">Nhập chỉ số điện nước (Tháng này):</h5>
            <form method="POST" action="{{ url_for('ql_hoa_don') }}">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label text-secondary">Chọn Phòng Đang Thuê</label>
                        <select name="ma_can" class="form-select" required>
                            <option value="" selected disabled>-- Chọn phòng --</option>
                            {% if phong_da_thue %}
                                {% for can in phong_da_thue %}
                                    <option value="{{ can.ma_can }}">{{ can.ma_can }} ({{ can.loai_phong }})</option>
                                {% endfor %}
                            {% else %}
                                <option disabled>Chưa có phòng nào được thuê</option>
                            {% endif %}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label text-secondary">Tháng Thu Tiền</label>
                        <input type="text" name="thang" class="form-control" placeholder="VD: 10/2025" required>
                    </div>

                    <div class="col-md-4 d-flex align-items-end">
                        <div class="alert alert-info py-1 px-2 w-100 mb-0 small">
                            <i class="fa-solid fa-bolt"></i> Giá điện: <b>{{ "{:,.0f}".format(quy_dinh.gia_dien) }}</b> |
                            <i class="fa-solid fa-droplet"></i> Nước: <b>{{ "{:,.0f}".format(quy_dinh.gia_nuoc) }}</b>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label text-warning">Điện Cũ (kWh)</label>
                        <input type="number" name="dien_cu" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-warning">Điện Mới (kWh)</label>
                        <input type="number" name="dien_moi" class="form-control" required>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label text-info">Nước Cũ (m³)</label>
                        <input type="number" name="nuoc_cu" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-info">Nước Mới (m³)</label>
                        <input type="number" name="nuoc_moi" class="form-control" required>
                    </div>

                    <div class="col-md-12 text-end mt-3">
                        <button type="submit" class="btn btn-success fw-bold px-4"><i class="fa-solid fa-check"></i> Tính Tiền & Lưu</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-dark-custom table-bordered">
            <thead>
                <tr>
                    <th>Phòng</th>
                    <th>Tháng</th>
                    <th>Điện (Số)</th>
                    <th>Nước (Khối)</th>
                    <th>Tiền Phòng</th>
                    <th>Tiền Điện</th>
                    <th>Tiền Nước</th>
                    <th>Dịch Vụ</th>
                    <th>TỔNG CỘNG</th>
                    <th>Trạng Thái</th>
                    <th>Hành Động</th> </tr>
            </thead>
            <tbody>
                {% for hd in ds_hoa_don %}
                <tr>
                    <td class="fw-bold text-warning">{{ hd.ma_can }}</td>
                    <td>{{ hd.thang }}</td>

                    <td>
                        <span class="text-muted small">{{ hd.dien_cu }}</span> <i class="fa-solid fa-arrow-right text-secondary"></i> <b>{{ hd.dien_moi }}</b>
                        <br><span class="badge bg-secondary">{{ hd.dien_moi - hd.dien_cu }} số</span>
                    </td>

                    <td>
                        <span class="text-muted small">{{ hd.nuoc_cu }}</span> <i class="fa-solid fa-arrow-right text-secondary"></i> <b>{{ hd.nuoc_moi }}</b>
                        <br><span class="badge bg-secondary">{{ hd.nuoc_moi - hd.nuoc_cu }} m³</span>
                    </td>

                    <td class="text-start">{{ "{:,.0f}".format(hd.tien_phong) }}</td>
                    <td class="text-start">{{ "{:,.0f}".format(hd.tien_dien) }}</td>
                    <td class="text-start">{{ "{:,.0f}".format(hd.tien_nuoc) }}</td>
                    <td class="text-start">{{ "{:,.0f}".format(hd.phi_dich_vu) }}</td>

                    <td class="fw-bold text-success fs-6">{{ "{:,.0f}".format(hd.tong_cong) }}</td>

                    <td>
                        {% if hd.trang_thai == 'ChuaThu' %}
                            <span class="badge bg-danger">Chưa Thu</span>
                        {% elif hd.trang_thai == 'DaThu' %}
                            <span class="badge bg-success">Đã Thu</span>
                        {% elif hd.trang_thai == 'ChoDuyet' %}
                            <span class="badge bg-warning text-dark blink-soft">
                                <i class="fa-solid fa-spinner fa-spin"></i> Chờ Duyệt
                            </span>
                        {% endif %}
                    </td>

                    <td>
                        {% if hd.trang_thai == 'ChoDuyet' %}
                            <a href="{{ url_for('admin_duyet_thanh_toan', id_hoa_don=hd.id) }}" class="btn btn-sm btn-success fw-bold" title="Xác nhận đã nhận tiền">
                                <i class="fa-solid fa-check"></i> Duyệt
                            </a>
                        {% elif hd.trang_thai == 'ChuaThu' %}
                            <button class="btn btn-sm btn-secondary" disabled title="Khách chưa báo đóng">--</button>
                        {% else %}
                            <span class="text-success"><i class="fa-solid fa-check-double"></i> Xong</span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="11" class="text-center py-4 text-muted">Chưa có hóa đơn nào được lập.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}